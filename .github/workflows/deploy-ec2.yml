name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # main ë¸Œëžœì¹˜ì— push ì‹œ ìžë™ ë°°í¬
      - master
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

env:
  NODE_VERSION: '20.x'

jobs:
  # 1. í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ ê²€ì¦
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: devtalk/package-lock.json

      - name: Install dependencies
        working-directory: ./devtalk
        run: npm ci

      - name: Run linter
        working-directory: ./devtalk
        run: npm run lint || true  # lint ì˜¤ë¥˜ê°€ ìžˆì–´ë„ ê³„ì† ì§„í–‰ (ì„ íƒì‚¬í•­)

      - name: Run tests
        working-directory: ./devtalk
        run: npm test || true  # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ ë°°í¬ ì§„í–‰ (ì„ íƒì‚¬í•­)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}

      - name: Generate Prisma Client
        working-directory: ./devtalk
        run: npm run db:generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Build application
        working-directory: ./devtalk
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            devtalk/.next
            devtalk/node_modules
            devtalk/package.json
            devtalk/package-lock.json
            devtalk/prisma
            devtalk/server.ts
            devtalk/next.config.ts
            devtalk/tsconfig.json
          retention-days: 1

  # 2. EC2ì— ë°°í¬
  deploy:
    name: Deploy to EC2
    needs: test-and-build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: devtalk

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: Add EC2 to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            mkdir -p ~/devtalk-deploy
            mkdir -p ~/devtalk-backup
          EOF

      - name: Backup current deployment
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            if [ -d ~/devtalk/current ]; then
              echo "Backing up current deployment..."
              cp -r ~/devtalk/current ~/devtalk-backup/backup-$(date +%Y%m%d-%H%M%S) || true
            fi
          EOF

      - name: Copy files to EC2
        run: |
          # ì••ì¶•í•˜ì—¬ ì „ì†¡ (ë” ë¹ ë¦„)
          tar -czf deploy.tar.gz -C devtalk \
            .next \
            node_modules \
            package.json \
            package-lock.json \
            prisma \
            server.ts \
            next.config.ts \
            tsconfig.json \
            lib \
            app \
            components \
            public \
            stores \
            types \
            workers \
            eslint.config.mjs \
            postcss.config.mjs \
            tailwind.config.ts \
            prisma.config.ts \
            vitest.config.ts

          scp deploy.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/devtalk-deploy/

      - name: Deploy on EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            DEPLOY_DIR="$HOME/devtalk"
            mkdir -p $DEPLOY_DIR/current
            cd $DEPLOY_DIR/current
            
            # ì´ì „ ë°°í¬ê°€ ìžˆìœ¼ë©´ ë°±ì—…
            if [ -f server.ts ]; then
              echo "ðŸ“¦ Backing up previous deployment..."
              mkdir -p $HOME/devtalk-backup
              BACKUP_NAME="backup-$(date +%Y%m%d-%H%M%S)"
              cp -r . $HOME/devtalk-backup/$BACKUP_NAME || true
            fi
            
            # ì••ì¶• í•´ì œ
            echo "ðŸ“‚ Extracting files..."
            tar -xzf ~/devtalk-deploy/deploy.tar.gz -C $DEPLOY_DIR/current
            
            # Prisma Client ìž¬ìƒì„± (í™˜ê²½ ë³€ìˆ˜ í•„ìš”)
            echo "ðŸ”„ Generating Prisma Client..."
            cd $DEPLOY_DIR/current
            npm run db:generate || echo "Prisma generate skipped (no DATABASE_URL)"
            
            # PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ìž¬ì‹œìž‘
            echo "ðŸ”„ Restarting application with PM2..."
            pm2 restart devtalk || pm2 start npm --name "devtalk" -- start
            
            # PM2 ìƒíƒœ í™•ì¸
            echo "ðŸ“Š PM2 Status:"
            pm2 status
            
            # ë¡œê·¸ í™•ì¸ (ìµœê·¼ 20ì¤„)
            echo "ðŸ“‹ Recent logs:"
            pm2 logs devtalk --lines 20 --nostream || true
            
            echo "âœ… Deployment completed!"
          ENDSSH

      - name: Health check
        run: |
          echo "ðŸ¥ Running health check..."
          sleep 5  # ì„œë²„ ì‹œìž‘ ëŒ€ê¸°
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}:3000 || echo "000")
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "âœ… Health check passed! HTTP $HTTP_CODE"
          else
            echo "âš ï¸ Health check warning: HTTP $HTTP_CODE"
            echo "ì„œë²„ê°€ ì•„ì§ ì‹œìž‘ ì¤‘ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f deploy.tar.gz

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi

